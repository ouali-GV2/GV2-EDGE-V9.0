services:

  ibgateway:
    image: ghcr.io/gnzsnz/ib-gateway:10.44.1f
    container_name: ibgateway
    restart: unless-stopped

    environment:
      - TWS_USERID=${IBKR_USER}
      - TWS_PASSWORD=${IBKR_PASS}
      - TRADING_MODE=${TRADING_MODE:-paper}
      - TZ=America/New_York

    ports:
      - "4001:4003"
      - "4002:4004"

    volumes:
      - ibgateway-jts:/home/ibgateway/jts
      - ibgateway-ibc:/home/ibgateway/ibc

    mem_limit: 2g
    mem_reservation: 1g

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  gv2-edge:
    build: .
    container_name: gv2-edge
    restart: unless-stopped

    depends_on:
      ibgateway:
        condition: service_started

    ports:
      - "8501:8501"

    volumes:
      - ./data:/app/data

    env_file:
      - .env

    environment:
      - TZ=UTC
      - IBKR_HOST=ibgateway
      - IBKR_PORT=4004
      - USE_IBKR_DATA=True

    mem_limit: 4g
    mem_reservation: 2g

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"

volumes:
  ibgateway-jts:
    driver: local
  ibgateway-ibc:
    driver: local
